{% extends "base.html" %}

{% block title %}{{ subject.name }} - {{ subject.course.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Subject Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('view_course', course_id=subject.course.id) }}">
                            {{ subject.course.name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">{{ subject.name }}</li>
                </ol>
            </nav>

            <div class="bg-gradient-primary text-white rounded-3 p-4 domain-{{ subject.subject_domain }}"
                 style="background: linear-gradient(135deg,
                    {% if subject.subject_domain == 'economics' %}#3498db, #2980b9
                    {% elif subject.subject_domain == 'computer_science' %}#9b59b6, #8e44ad
                    {% elif subject.subject_domain == 'mathematics' %}#e67e22, #d35400
                    {% elif subject.subject_domain == 'psychology' %}#1abc9c, #16a085
                    {% elif subject.subject_domain == 'business' %}#34495e, #2c3e50
                    {% elif subject.subject_domain == 'engineering' %}#e74c3c, #c0392b
                    {% elif subject.subject_domain == 'medicine' %}#27ae60, #229954
                    {% else %}#95a5a6, #7f8c8d{% endif %} 100%);">

                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center mb-2">
                            <h1 class="display-6 mb-0 me-3">{{ subject.name }}</h1>
                            <div>
                                <span class="badge bg-light text-dark">{{ subject.get_domain_display_name() }}</span>
                                <span class="badge bg-warning text-dark ms-2">{{ subject.complexity_level.title() }}</span>
                            </div>
                        </div>

                        {% if subject.preface %}
                            {% set preface_data = subject.preface | from_json %}
                            {% if preface_data.welcome_message %}
                                <p class="lead mb-2">{{ preface_data.welcome_message }}</p>
                            {% endif %}
                        {% endif %}

                        <div class="d-flex align-items-center">
                            <i class="fas fa-book me-2"></i>
                            <span>{{ subject.total_chapters }} chapters â€¢ {{ (subject.estimated_read_time / 60)|round(1) }} hours</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex justify-content-end align-items-center gap-4">
                            <div class="text-center">
                                <div class="h3 mb-0">75%</div>
                                <small>Progress</small>
                            </div>
                            <div class="progress-ring">
                                <svg width="80" height="80">
                                    <circle cx="40" cy="40" r="35" stroke="#ffffff30" stroke-width="6" fill="transparent"/>
                                    <circle class="progress" cx="40" cy="40" r="35" stroke="#ffffff" stroke-width="6" fill="transparent"
                                            style="stroke-linecap: round; stroke-dasharray: 220; stroke-dashoffset: 55;"/>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <div class="h4 mb-0">75%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Learning Objectives -->
            {% if subject.preface %}
            {% set preface_data = subject.preface | from_json %}
            {% if preface_data.learning_objectives %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Learning Objectives</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for objective in preface_data.learning_objectives %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                <span>{{ objective }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if preface_data.real_world_relevance %}
                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Real-World Relevance</h6>
                        <p class="mb-0">{{ preface_data.real_world_relevance }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Chapter List -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-list-ol me-2"></i>Chapters</h3>
                <div>
                    <span class="badge bg-primary">{{ subject.chapters|length }} Chapters</span>
                    <span class="badge bg-info ms-2">{{ subject.interactive_elements_count }} Interactive Elements</span>
                </div>
            </div>

            {% if subject.chapters %}
            <div class="row">
                {% for chapter in subject.chapters %}
                {% set progress = chapter_progress.get(chapter.id) %}

                <div class="col-lg-6 mb-4">
                    <div class="card card-hover border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    <h6 class="text-muted mb-1">Chapter {{ chapter.chapter_number or loop.index }}</h6>
                                    <h5 class="card-title mb-2">
                                        <a href="{{ url_for('view_chapter',
                                                  course_id=subject.course.id,
                                                  subject_id=subject.id,
                                                  chapter_id=chapter.id) }}"
                                           class="text-decoration-none">
                                            {{ chapter.title }}
                                        </a>
                                    </h5>
                                    <div class="mb-2">
                                        <span class="badge bg-secondary">{{ chapter.difficulty_level.title() }}</span>
                                        <span class="badge bg-light text-dark ms-1">
                                            <i class="fas fa-clock"></i> {{ chapter.estimated_study_time }}min
                                        </span>
                                    </div>
                                </div>

                                <div class="text-end">
                                    {% if progress %}
                                        {% if progress.status == 'completed' %}
                                            <div class="text-success">
                                                <i class="fas fa-check-circle fa-2x"></i>
                                                <div class="small">Completed</div>
                                            </div>
                                        {% elif progress.status == 'in_progress' %}
                                            <div class="text-warning">
                                                <i class="fas fa-play-circle fa-2x"></i>
                                                <div class="small">In Progress</div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-circle fa-2x"></i>
                                            <div class="small">Not Started</div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Chapter Stats -->
                            <div class="row g-2 mb-3 text-center small">
                                <div class="col-4">
                                    <div class="text-muted">Content Blocks</div>
                                    <div class="fw-bold">{{ chapter.total_content_blocks }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted">Charts</div>
                                    <div class="fw-bold">{{ chapter.visualization_count }}</div>
                                </div>
                                <div class="col-4">
                                    <div class="text-muted">Exercises</div>
                                    <div class="fw-bold">{{ chapter.exercise_count }}</div>
                                </div>
                            </div>

                            <!-- Chapter Summary Preview -->
                            {% if chapter.intro_summary %}
                            {% set intro_data = chapter.intro_summary | from_json %}
                            {% if intro_data.main_concepts %}
                            <div class="mb-3">
                                <div class="small text-muted mb-1">Key Concepts:</div>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for concept in intro_data.main_concepts[:3] %}
                                    <span class="badge bg-light text-dark">{{ concept }}</span>
                                    {% endfor %}
                                    {% if intro_data.main_concepts|length > 3 %}
                                    <span class="badge bg-light text-dark">+{{ intro_data.main_concepts|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}

                            <!-- Progress Details -->
                            {% if progress %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Progress</small>
                                    <small class="text-muted">{{ progress.completion_percentage|int }}%</small>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" style="width: {{ progress.completion_percentage }}%"></div>
                                </div>

                                <div class="row mt-2 small text-muted">
                                    <div class="col-6">
                                        <i class="fas fa-clock me-1"></i>{{ progress.time_spent_minutes or 0 }}min studied
                                    </div>
                                    <div class="col-6">
                                        <i class="fas fa-question-circle me-1"></i>{{ progress.questions_asked or 0 }} questions
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('view_chapter',
                                          course_id=subject.course.id,
                                          subject_id=subject.id,
                                          chapter_id=chapter.id) }}"
                                   class="btn btn-primary btn-sm flex-fill">
                                    <i class="fas fa-play me-1"></i>
                                    {% if progress and progress.status == 'completed' %}
                                        Review
                                    {% elif progress and progress.status == 'in_progress' %}
                                        Continue
                                    {% else %}
                                        Start
                                    {% endif %}
                                </a>

                                {% if progress and progress.quizzes_taken > 0 %}
                                <a href="{{ url_for('generate_quiz', chapter_id=chapter.id) }}"
                                   class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-brain"></i> Quiz
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-book-open text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">No chapters available</h4>
                <p class="text-muted">This subject doesn't have any chapters yet.</p>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Subject Overview -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Subject Overview</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="h5 mb-1 text-primary">{{ subject.total_chapters }}</div>
                            <div class="small text-muted">Chapters</div>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-1 text-success">{{ (subject.estimated_read_time / 60)|round(1) }}h</div>
                            <div class="small text-muted">Est. Time</div>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-1 text-info">{{ subject.interactive_elements_count }}</div>
                            <div class="small text-muted">Interactive</div>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-1 text-warning">{{ subject.learning_style.title() }}</div>
                            <div class="small text-muted">Style</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subject Analysis -->
            {% if subject_analysis %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-brain me-2"></i>AI Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="small text-muted mb-1">Domain</div>
                        <span class="badge bg-{{ subject.subject_domain }}">{{ subject.get_domain_display_name() }}</span>
                    </div>

                    {% if subject_analysis.key_characteristics %}
                    <div class="mb-3">
                        <div class="small text-muted mb-1">Characteristics</div>
                        {% for char in subject_analysis.key_characteristics[:3] %}
                        <div class="small"><i class="fas fa-dot-circle text-primary me-1"></i>{{ char.title() }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if subject_analysis.career_applications %}
                    <div>
                        <div class="small text-muted mb-1">Career Paths</div>
                        {% for career in subject_analysis.career_applications[:3] %}
                        <span class="badge bg-light text-dark me-1 mb-1">{{ career }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Study Progress -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Your Progress</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">Overall Completion</span>
                            <span class="small fw-bold">75%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: 75%"></div>
                        </div>
                    </div>

                    <div class="row g-2 text-center small">
                        <div class="col-6">
                            <div class="fw-bold text-success">8</div>
                            <div class="text-muted">Completed</div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold text-warning">2</div>
                            <div class="text-muted">In Progress</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="generateSubjectNotes()">
                            <i class="fas fa-file-alt me-2"></i>Export Notes
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="takeFullQuiz()">
                            <i class="fas fa-brain me-2"></i>Subject Quiz
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showProgressDetails()">
                            <i class="fas fa-chart-bar me-2"></i>Detailed Stats
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="resetProgress()">
                            <i class="fas fa-redo me-2"></i>Reset Progress
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize any interactive elements
        updateProgressRings();
    });

    function updateProgressRings() {
        // Update progress ring visualization
        const progressRings = document.querySelectorAll('.progress-ring');
        progressRings.forEach(ring => {
            // This would normally get real progress data
            setProgress(ring, 75);
        });
    }

    function setProgress(element, percent) {
        const circle = element.querySelector('.progress');
        const radius = circle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = circumference - (percent / 100) * circumference;
    }

    function generateSubjectNotes() {
        showToast('Generating comprehensive subject notes...', 'info');
        // Implementation would compile all chapter notes for this subject
        setTimeout(() => {
            showToast('Subject notes generated!', 'success');
        }, 2000);
    }

    function takeFullQuiz() {
        if (confirm('This will generate a comprehensive quiz covering all chapters. Continue?')) {
            showToast('Generating subject-wide quiz...', 'info');
            // Implementation would create quiz from all chapters
        }
    }

    function showProgressDetails() {
        // Implementation would show detailed progress modal
        showToast('Detailed progress analytics coming soon!', 'info');
    }

    function resetProgress() {
        if (confirm('Are you sure you want to reset all progress for this subject? This cannot be undone.')) {
            showToast('Progress reset functionality would be implemented here', 'warning');
        }
    }

    function showToast(message, type = 'info') {
        // Create toast notification
        const toastContainer = document.getElementById('toast-container') || createToastContainer();

        const toastId = 'toast-' + Date.now();
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type}" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1050';
        document.body.appendChild(container);
        return container;
    }
</script>
{% endblock %}